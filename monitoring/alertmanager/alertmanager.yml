global:
  resolve_timeout: 5m
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'trading-bot-alerts@example.com'
  smtp_auth_username: '${ALERT_EMAIL_USERNAME}'
  smtp_auth_password: '${ALERT_EMAIL_PASSWORD}'
  smtp_require_tls: true

# Templates para mensagens customizadas
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Roteamento de alertas
route:
  group_by: ['alertname', 'severity', 'cluster']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'

  routes:
    # Alertas CR√çTICOS - Notifica√ß√£o imediata em todos os canais
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      continue: true

    # Alertas de WARNING - Apenas Telegram
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 1h

    # Alertas de Trading - Canal espec√≠fico
    - match:
        category: trading
      receiver: 'trading-alerts'
      group_wait: 10s
      repeat_interval: 30m

    # Alertas de ML Model - Canal espec√≠fico
    - match:
        category: ml-model
      receiver: 'ml-alerts'
      group_wait: 1m
      repeat_interval: 2h

    # Alertas de Infraestrutura
    - match:
        category: infrastructure
      receiver: 'infra-alerts'
      group_wait: 30s
      repeat_interval: 1h

# Configura√ß√£o de receivers (destinos das notifica√ß√µes)
receivers:
  # Receiver padr√£o
  - name: 'default'
    email_configs:
      - to: '${ALERT_EMAIL_TO}'
        headers:
          Subject: '[Trading Bot] {{ .GroupLabels.alertname }}'

  # CR√çTICO - Email + Telegram + Webhook
  - name: 'critical-alerts'
    email_configs:
      - to: '${ALERT_EMAIL_TO}'
        headers:
          Subject: 'üö® [CR√çTICO] Trading Bot Alert: {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: red;">üö® ALERTA CR√çTICO</h2>
          <p><strong>Alerta:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Severidade:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>Descri√ß√£o:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>Hora:</strong> {{ .StartsAt }}</p>
          <p><strong>A√ß√£o:</strong> {{ .CommonAnnotations.action }}</p>

    telegram_configs:
      - bot_token: '${TELEGRAM_BOT_TOKEN}'
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: 'HTML'
        message: |
          üö® <b>ALERTA CR√çTICO - Trading Bot</b>

          <b>Alerta:</b> {{ .GroupLabels.alertname }}
          <b>Severidade:</b> {{ .CommonLabels.severity }}

          <b>Descri√ß√£o:</b>
          {{ .CommonAnnotations.description }}

          <b>A√ß√£o Requerida:</b>
          {{ .CommonAnnotations.action }}

          <b>Hora:</b> {{ .StartsAt.Format "02/01/2006 15:04:05" }}

    webhook_configs:
      - url: '${ALERT_WEBHOOK_URL}'
        send_resolved: true

  # WARNING - Apenas Telegram
  - name: 'warning-alerts'
    telegram_configs:
      - bot_token: '${TELEGRAM_BOT_TOKEN}'
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: 'HTML'
        message: |
          ‚ö†Ô∏è <b>Alerta - Trading Bot</b>

          <b>Tipo:</b> {{ .GroupLabels.alertname }}
          <b>Descri√ß√£o:</b> {{ .CommonAnnotations.description }}

          <i>Hora:</i> {{ .StartsAt.Format "02/01/2006 15:04:05" }}

  # Trading Alerts - Email + Telegram
  - name: 'trading-alerts'
    email_configs:
      - to: '${ALERT_EMAIL_TO}'
        headers:
          Subject: 'üìä [Trading] {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: orange;">üìä Trading Alert</h2>
          <p><strong>Alerta:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Descri√ß√£o:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>M√©trica:</strong> {{ .CommonAnnotations.metric }}</p>
          <p><strong>Valor Atual:</strong> {{ .CommonAnnotations.value }}</p>
          <p><strong>Limiar:</strong> {{ .CommonAnnotations.threshold }}</p>

    telegram_configs:
      - bot_token: '${TELEGRAM_BOT_TOKEN}'
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: 'HTML'
        message: |
          üìä <b>Trading Alert</b>

          <b>{{ .GroupLabels.alertname }}</b>
          {{ .CommonAnnotations.description }}

          <b>M√©trica:</b> {{ .CommonAnnotations.metric }}
          <b>Valor:</b> {{ .CommonAnnotations.value }}
          <b>Limiar:</b> {{ .CommonAnnotations.threshold }}

  # ML Model Alerts
  - name: 'ml-alerts'
    telegram_configs:
      - bot_token: '${TELEGRAM_BOT_TOKEN}'
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: 'HTML'
        message: |
          ü§ñ <b>ML Model Alert</b>

          <b>{{ .GroupLabels.alertname }}</b>
          {{ .CommonAnnotations.description }}

          <b>Modelo:</b> {{ .CommonAnnotations.model }}
          <b>M√©trica:</b> {{ .CommonAnnotations.metric }}
          <b>Valor:</b> {{ .CommonAnnotations.value }}

  # Infrastructure Alerts
  - name: 'infra-alerts'
    telegram_configs:
      - bot_token: '${TELEGRAM_BOT_TOKEN}'
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: 'HTML'
        message: |
          üèóÔ∏è <b>Infrastructure Alert</b>

          <b>{{ .GroupLabels.alertname }}</b>
          {{ .CommonAnnotations.description }}

          <b>Servi√ßo:</b> {{ .CommonLabels.job }}
          <b>Inst√¢ncia:</b> {{ .CommonLabels.instance }}

# Configura√ß√£o de inibi√ß√£o (evita alertas duplicados)
inhibit_rules:
  # Se h√° um alerta cr√≠tico, suprimir warnings relacionados
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']

  # Se sistema est√° down, suprimir alertas de performance
  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      alertname: '(HighCPU|HighMemory|HighDisk)'
    equal: ['instance']
